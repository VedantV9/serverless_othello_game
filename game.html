<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Emoji Slots</title>
        <link href="game.css" rel="stylesheet" type="text/css">
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.20.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script type="text/javascript">
            // Configure AWS SDK for JavaScript
            AWS.config.update({region: 'eu-west-1'});
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({IdentityPoolId: 'eu-west-1:8fd4aff6-c2e8-42f8-858c-21080b3a9a4b'});

            // Make the call to obtain credentials
            var identityId = null;
            // see documentation at : http://docs.aws.amazon.com/cognito/latest/developerguide/google.html
            AWS.config.credentials.get(function(){
                // Credentials will be available when this function is called.
                var accessKeyId = AWS.config.credentials.accessKeyId;
                var secretAccessKey = AWS.config.credentials.secretAccessKey;
                var sessionToken = AWS.config.credentials.sessionToken;

                identityId = AWS.config.credentials.identityId;
                console.log(identityId);
                //alert(identityId);
            });


            var GAME_ID = null;
            var START_STAMP = null;

            // to create, read, update a DB record :
            // http://docs.aws.amazon.com/amazondynamodb/latest/gettingstartedguide/GettingStarted.Js.03.html#GettingStarted.Js.03.01

            // Lambda calls from Javascript documented here :
            // http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/browser-invoke-lambda-function-example.html
            
            // Prepare to call Lambda function
            var lambda = new AWS.Lambda({region: 'eu-west-1', apiVersion: '2015-03-31'});

            function gameCreate() {
                var Payload = {};
                var lambdaParams = {
                    FunctionName : 'gameCreate',
                    InvocationType : 'RequestResponse',
                    Payload: JSON.stringify(Payload),
                    LogType : 'None'
                };
                // Call the Lambda function to collect the spin results
                lambda.invoke(lambdaParams, function(err, data) {
                    if (err) {
                        console.log(err);
                        GAME_ID = null;
                        START_STAMP = null;
                    } else {
                        var pullResults = JSON.parse(data.Payload);
                        console.log(pullResults.game_id);
                        console.log(pullResults.start_stamp);
                        GAME_ID = pullResults.game_id;
                        START_STAMP = pullResults.start_stamp;
                        gameRead();
                    }
                });
            }

            var docClient = new AWS.DynamoDB.DocumentClient();

            function gameRead() {
                var params = {
                    TableName: 'Othello',
                    Key: {
                        'game_id': GAME_ID,
                        'start_stamp': START_STAMP
                    }
                };
                docClient.get(params, function(err, data) {
                    if (err) {
                        console.log("Unable to read item: " + "\n" + JSON.stringify(err, undefined, 2));
                    } else {
                        console.log("GetItem succeeded: " + "\n" + JSON.stringify(data, undefined, 2));
                        //
                        for(var i=0; i<10; i++){
                            for(var j = 0; j<10; j++){
                                board[i][j] = data.Item.board[i][j];
                            }
                        }
                        turn = data.Item.turn;
                        showBoard();
                    }
                });
            }
            
            function boardUpdate(game_id, start_stamp, player, row, column) {
                var Payload = {
                    'game_id': game_id,
                    'start_stamp': start_stamp,
                    'player': player, // we pass the player as well to insure consistency with expected turn
                    'row': row,
                    'column': column
                };
                console.log(JSON.stringify(Payload));
                var lambdaParams = {
                    FunctionName : 'boardUpdate',
                    InvocationType : 'RequestResponse',
                    Payload: JSON.stringify(Payload),
                    LogType : 'None'
                };
                // Call the Lambda function to collect the spin results
                lambda.invoke(lambdaParams, function(err, data) {
                    if (err) {
                        prompt(err);
                    } else {
                        var pullResults = JSON.parse(data.Payload);
                        console.log(pullResults);
                    }
                });
            }

            var piece = [];
            var turn;
            
            // see this example : https://codepen.io/k44/pen/zKiIo
            // this function checks that a cell can be flipped and *optionaly* flips it
            var checkPiece = function(x, y, flip) {
                var ret = 0;
                for (var dx = -1; dx <= 1; dx++) {
                    for (var dy = -1; dy <= 1; dy++) {
                        if (dx == 0 && dy == 0) {
                            continue;
                        }
                        var nx = x + dx, ny = y + dy, n = 0;
                        while (board[nx][ny] == ((turn == 'W') ? 'B' : 'W')) {
                            n++;
                            nx += dx;
                            ny += dy;
                        }
                        if (n > 0 && board[nx][ny] == turn) {
                            ret += n;
                            if (flip) { // This logic should be part of the Lambda too
                                nx = x + dx;
                                ny = y + dy;
                                while (board[nx][ny] == ((turn == 'W') ? 'B' : 'W')) {
                                    board[nx][ny] = turn;
                                    nx += dx;
                                    ny += dy;
                                }
                                board[x][y] = turn;
                            }
                        }
                    }
                }
                // Lambda
                if ((ret>0) && (flip)) {
                    console.log(x);
                    console.log(y);
                    boardUpdate(GAME_ID, START_STAMP, turn, x, y);
                }
                return ret;
            }
            
            // see this example : https://codepen.io/k44/pen/zKiIo
            var turnChange = function() {
                // step 1 : flip turn and check that new player has available options
                turn = ((turn == 'W') ? 'B' : 'W');
                for (var x = 1; x <= 8; x++) {
                    for (var y = 1; y <= 8; y++) {
                        if (board[x][y] == '0' && checkPiece(x, y, false)) {
                            showBoard();
                            return; // returns with the flipped player
                        }
                    }
                }
                // conditional step 2 : IF the flipped player was blocked then revert and check if player has available moves
                turn = ((turn == 'W') ? 'B' : 'W');
                for (var x = 1; x <= 8; x++) {
                    for (var y = 1; y <= 8; y++) {
                        if (board[x][y] == '0' && checkPiece(x, y, false)) {
                            showBoard();
                            return; // return with the previous player
                        }
                    }
                }
                // conditional step 3 : both players are blocked, so end the game
                turn = 'E';
                showBoard();
                return;
            }
            
            // see this example : https://codepen.io/k44/pen/zKiIo
            // purely UI function
            var showBoard = function() {
                var b = document.getElementById('board');
                while (b.firstChild){
                    b.removeChild(b.firstChild);
                }
                for (var row=1; row<=8; row++){
                    for (var col=1; col<=8; col++){
                        var cell = piece[board[row][col]].cloneNode(true);
                        cell.style.top = ((row - 1) * 32) + "px";
                        cell.style.left = ((col - 1) * 32) + "px";
                        b.appendChild(cell);
                        
                        if (board[row][col] == '0'){
                            (function(){
                                var _row = row;
                                var _col = col;
                                // attach CLICK event handler to each cell
                                cell.onclick = function(){
                                    if (checkPiece(_row, _col, true)) {
                                        turnChange();
                                    }
                                }
                            })();
                        }
                    }
                }
                //
                if ((turn == 'B' ) || (turn == 'W'))
                {
                    var message = ((turn == 'B') ? 'black' : 'white');
                    document.getElementById('message').innerHTML = message + "'s move";
                }
                else // if turn == 'E' // E for End of game
                {
                    var countB = 0;
                    var countW = 0;
                    for (var x = 1; x <= 8; x++) {
                        for (var y = 1; y <= 8; y++) {
                            if (board[x][y] == 'B') { // player 1
                                countB++;
                            }
                            if (board[x][y] == 'W') { // player 2
                                countW++;
                            }
                        }
                    }
                    message = 'black: ' + countB + ' | white: ' + countW + '</br>';
                    if (countB == countW) {
                        message += 'draw';
                    }
                    else {
                        message += ((countB > countW) ? 'black': 'white') + ' wins';
                    }
                    document.getElementById('message').innerHTML = message;
                }
            }
            
            var initPiece = function() {
                piece = {
                    '0': document.getElementById('empty'), // DOM need to exist for this
                    'B': document.getElementById('black'),
                    'W': document.getElementById('white')
                };
            }

            var initGame = function() {
                // Should call a Lambda function to create a new DB entry
                for (var i = 0; i < 10; i++){
                    board[i] = [];
                    for (var j = 0; j < 10; j++){
                        board[i][j] = '0';
                    }
                }

                gameCreate();
            }
            
            var board = [];
            
            window.onload = function() {
                initPiece();
                initGame()
                document.getElementById('reset').onclick = function(){
                    initGame();
                }
            }

        </script>
    </head>
    <body>

        <div id="template">
            <div id="empty" class="cell"><div></div></div>
            <div id="black" class="cell"><div></div></div>
            <div id="white" class="cell"><div></div></div>
        </div>

        <div id="wrap">
            <h1>Othello</h1>
            <div id="board"></div>
            <p id="message"></p>
            <input type="button" id="reset" value="reset">
        </div>

    </body>
</html>