<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Emoji Slots</title>
        <link href="game.css" rel="stylesheet" type="text/css">
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.20.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script type="text/javascript">
            // Configure AWS SDK for JavaScript
            AWS.config.update({region: 'eu-west-1'});
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({IdentityPoolId: 'eu-west-1:8fd4aff6-c2e8-42f8-858c-21080b3a9a4b'});

            var dynamodb = new AWS.DynamoDB();          

            var game = null;

            /* Makes a scan of the DynamoDB table to set a data object for the chart */
            function getData() {
                var params = { TableName: 'Othello' };
                dynamodb.scan(params, function(err, data) {
                    if (err) {
                        console.log(err);
                        return null;
                    }
                    else {
                        console.log(data);
                        //game = data.Items[0]; // maybe easier to update ?
                        var aux = data.Items[0];
                        game = {};
                        //game['board'] = aux.board.SS;
                        game['turn'] = aux.turn.S;
                        game['start_stamp'] = aux.start_stamp.N;
                    }
                });
            }
            // to update a record :
            // http://docs.aws.amazon.com/amazondynamodb/latest/gettingstartedguide/GettingStarted.Js.03.html#GettingStarted.Js.03.01


            // Lambda calls from Javascript documented here :
            // http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/browser-invoke-lambda-function-example.html
            
            // Prepare to call Lambda function
            var lambda = new AWS.Lambda({region: 'eu-west-1', apiVersion: '2015-03-31'});
            
            
            function initiatePull() {
                var pullParams = {
                    FunctionName : 'slotPull',
                    InvocationType : 'RequestResponse',
                    Payload: '{ "name" : "Math" }',
                    LogType : 'None'
                }
                // Call the Lambda function to collect the spin results
                lambda.invoke(pullParams, function(err, data) {
                    if (err) {
                        prompt(err);
                    } else {
                        pullResults = JSON.parse(data.Payload);
                        console.log(pullResults);
                    }
                }); 
            }

            var docClient = new AWS.DynamoDB.DocumentClient();

            // example : readItem('11', 1);
            function readItem(game_id, start_stamp) {
                var params = {
                    TableName: 'Othello',
                    Key: {
                        'game_id': game_id,
                        'start_stamp': start_stamp
                    }
                };
                docClient.get(params, function(err, data) {
                    if (err) {
                        console.log("Unable to read item: " + "\n" + JSON.stringify(err, undefined, 2));
                    } else {
                        console.log("GetItem succeeded: " + "\n" + JSON.stringify(data, undefined, 2));
                        //
                        for(var i = 1; i < 9; i++){
                            for(var j = 1; j < 9; j++){
                                board[i][j] = data.Item.board[i-1][j-1];
                            }
                        }
                        showBoard();
                    }
                });
            }
            
            function boardUpdate(game_id, start_stamp, player, row, column) {
                var Payload = {
                    'game_id': game_id,
                    'start_stamp': start_stamp,
                    'player': player,
                    'row': row,
                    'column': column
                };
                console.log(JSON.stringify(Payload));
                var lambdaParams = {
                    FunctionName : 'boardUpdate',
                    InvocationType : 'RequestResponse',
                    Payload: JSON.stringify(Payload),
                    LogType : 'None'
                };
                // Call the Lambda function to collect the spin results
                lambda.invoke(lambdaParams, function(err, data) {
                    if (err) {
                        prompt(err);
                    } else {
                        pullResults = JSON.parse(data.Payload);
                        console.log(pullResults);
                    }
                });
            }

            var piece = [];
            var turn;
            
            // see this example : https://codepen.io/k44/pen/zKiIo
            // this function checks that a cell can be flipped and *optionaly* flips it
            var checkPiece = function(x, y, flip) {
                var ret = 0;
                for (var dx = -1; dx <= 1; dx++) {
                    for (var dy = -1; dy <= 1; dy++) {
                        if (dx == 0 && dy == 0) {
                            continue;
                        }
                        var nx = x + dx, ny = y + dy, n = 0;
                        while (board[nx][ny] == ((turn == 'W') ? 'B' : 'W')) {
                            n++;
                            nx += dx;
                            ny += dy;
                        }
                        if (n > 0 && board[nx][ny] == turn) {
                            ret += n;
                            if (flip) { // This logic should be part of the Lambda too
                                nx = x + dx;
                                ny = y + dy;
                                while (board[nx][ny] == ((turn == 'W') ? 'B' : 'W')) {
                                    board[nx][ny] = turn;
                                    nx += dx;
                                    ny += dy;
                                }
                                board[x][y] = turn;
                            }
                        }
                    }
                }
                // Lambda
                if (flip) {
                    console.log(x);
                    console.log(y);
                    boardUpdate('11', 1, turn, x, y);
                }
                return ret;
            }
            
            // see this example : https://codepen.io/k44/pen/zKiIo
            var turnChange = function() {
                var b = 0;
                var w = 0;
                // step 1 : flip turn and check that new player has available options
                //turn = 3 - turn;
                turn = ((turn == 'W') ? 'B' : 'W');
                var message = ((turn == 'B') ? 'black' : 'white'); //((turn ==1)?"black":"white");
                for (var x = 1; x <= 8; x++) {
                    for (var y = 1; y <= 8; y++) {
                        if (board[x][y] == '0' && checkPiece(x, y, false)) {
                            document.getElementById('message').innerHTML = message + "'s move";
                            showBoard();
                            return; // returns with the flipped player
                        }
                    }
                }
                // conditional step 2 : IF the flipped player was blocked then revert and check if player has available moves
                turn = ((turn == 'W') ? 'B' : 'W');
                message += " pass</br>" + ((turn == 'B' )? 'black' : 'white') + "'s move";
                        
                for (var x = 1; x <= 8; x++) {
                    for (var y = 1; y <= 8; y++) {
                        if (board[x][y] == '0' && checkPiece(x, y, false)) {
                            document.getElementById('message').innerHTML = message;
                            showBoard();
                            return; // return with the previous player
                        }
                    }
                }

                // conditional step 3 : both players are blocked, so end the game
                for (var x = 1; x <= 8; x++) {
                    for (var y = 1; y <= 8; y++) {
                        if (board[x][y] == 'B') { // player 1
                            b++;
                        }
                        if (board[x][y] == 'W') { // player 2
                            w++;
                        }
                    }
                }
                message = 'black: ' + b + ' | white: ' + w + '</br>';
                if (b == w) {
                    message += 'draw';
                }
                else {
                    message += ((b > w) ? 'black': 'white') + ' wins';
                }
                document.getElementById('message').innerHTML = message;
                showBoard();
            }
            
            // see this example : https://codepen.io/k44/pen/zKiIo
            var showBoard = function(){
                var b = document.getElementById('board');
                while (b.firstChild){
                    b.removeChild(b.firstChild);
                }
                for (var y = 1; y <= 8; y++){
                    for (var x = 1; x <= 8; x++){
                        var c = piece[board[x][y]].cloneNode(true);
                        c.style.left = ((x - 1) * 32) + "px";
                        c.style.top = ((y - 1) * 32) + "px";
                        b.appendChild(c);
                        
                        if (board[x][y] == '0'){
                            (function(){
                                var _x = x, _y = y;
                                // attach CLICK event handler to each cell
                                c.onclick = function(){
                                    if(checkPiece(_x, _y, true)){
                                        turnChange();
                                    }
                                }
                            })();
                        }
                    }
                }
            }
            
            var init = function() {
                turn = 'W';//2;
                piece = {
                    '0': document.getElementById('empty'),
                    'B': document.getElementById('black'),
                    'W': document.getElementById('white')
                };
                
                for (var i = 0; i < 10; i++){
                    board[i] = [];
                    for (var j = 0; j < 10; j++){
                        board[i][j] = '0';
                    }
                }
                
                board[4][5] = 'B'; //1;
                board[5][4] = 'B'; //1;
                board[4][4] = 'W'; //2
                board[5][5] = 'W'; //2;
                turnChange();
                showBoard();
            }
            
            var board = [];
            
            window.onload = function() {
                init();
                document.getElementById('reset').onclick = function(){
                    init();
                }
            }

        </script>
    </head>
    <body>

        <div id="template">
            <div id="empty" class="cell"><div></div></div>
            <div id="black" class="cell"><div></div></div>
            <div id="white" class="cell"><div></div></div>
        </div>

        <div id="wrap">
            <h1>Othello</h1>
            <div id="board"></div>
            <p id="message"></p>
            <input type="button" id="reset" value="reset">
        </div>

    </body>
</html>