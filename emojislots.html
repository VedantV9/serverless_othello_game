<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Emoji Slots</title>
        <!--<link href="emojislots.css" rel="stylesheet" type="text/css">-->
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.20.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script type="text/javascript">
            // Configure AWS SDK for JavaScript
            AWS.config.update({region: 'eu-west-1'});
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({IdentityPoolId: 'eu-west-1:8fd4aff6-c2e8-42f8-858c-21080b3a9a4b'});

            var dynamodb = new AWS.DynamoDB();          

            var game = null;

            /* Makes a scan of the DynamoDB table to set a data object for the chart */
            function getData() {
                var params = { TableName: 'Othello' };
                dynamodb.scan(params, function(err, data) {
                    if (err) {
                        console.log(err);
                        return null;
                    }
                    else {
                        console.log(data);
                        //game = data.Items[0]; // maybe easier to update ?
                        var aux = data.Items[0];
                        game = {};
                        //game['board'] = aux.board.SS;
                        game['turn'] = aux.turn.S;
                        game['start_stamp'] = aux.start_stamp.N;
                    }
                });
            }
            // to update a record :
            // http://docs.aws.amazon.com/amazondynamodb/latest/gettingstartedguide/GettingStarted.Js.03.html#GettingStarted.Js.03.01


            // Lambda calls from Javascript documented here :
            // http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/browser-invoke-lambda-function-example.html
            
            // Prepare to call Lambda function
            var lambda = new AWS.Lambda({region: 'eu-west-1', apiVersion: '2015-03-31'});
            
            
            function initiatePull() {
                var pullParams = {
                    FunctionName : 'slotPull',
                    InvocationType : 'RequestResponse',
                    Payload: '{ "name" : "Math" }',
                    LogType : 'None'
                }
                // Call the Lambda function to collect the spin results
                lambda.invoke(pullParams, function(err, data) {
                    if (err) {
                        prompt(err);
                    } else {
                        pullResults = JSON.parse(data.Payload);
                        console.log(pullResults);
                    }
                }); 
            }

            var docClient = new AWS.DynamoDB.DocumentClient();

            // example : readItem('11', 1);
            function readItem(game_id, start_stamp) {
                var params = {
                    TableName: 'Othello',
                    Key: {
                        'game_id': game_id,
                        'start_stamp': start_stamp
                    }
                };
                docClient.get(params, function(err, data) {
                    if (err) {
                        console.log("Unable to read item: " + "\n" + JSON.stringify(err, undefined, 2));
                    } else {
                        console.log("GetItem succeeded: " + "\n" + JSON.stringify(data, undefined, 2));
                        drawBoard(data);
                    }
                });
            }

            function drawBoard(data)
            {
                console.log(data);
                for (var i=0; i<8; i++) {
                    for (var j=0; j<8; j++) {
                        document.getElementById(''+(i+1)+(j+1)).innerHTML = data.Item.board[i][j];
                    }
                }
            }
            
            function boardUpdate(game_id, start_stamp, player, row, column) {
                var Payload = {
                    'game_id': game_id,
                    'start_stamp': start_stamp,
                    'player': player,
                    'row': row,
                    'column': column
                };
                console.log(JSON.stringify(Payload));
                var lambdaParams = {
                    FunctionName : 'boardUpdate',
                    InvocationType : 'RequestResponse',
                    Payload: JSON.stringify(Payload),
                    LogType : 'None'
                };
                // Call the Lambda function to collect the spin results
                lambda.invoke(lambdaParams, function(err, data) {
                    if (err) {
                        prompt(err);
                    } else {
                        pullResults = JSON.parse(data.Payload);
                        console.log(pullResults);
                    }
                }); 
            }

        </script>
    </head>
    <body>
        <div id="appframe">

            <div id="board">
                <table>
                    <tr id='row1'>
                        <td id='11'></td><td id='12'></td>
                        <td id='13'></td><td id='14'></td>
                        <td id='15'></td><td id='16'></td>
                        <td id='17'></td><td id='18'></td>
                    </tr>
                    <tr id='row2'>
                        <td id='21'></td><td id='22'></td>
                        <td id='23'></td><td id='24'></td>
                        <td id='25'></td><td id='26'></td>
                        <td id='27'></td><td id='28'></td>
                    </tr>
                    <tr id='row3'>
                        <td id='31'></td><td id='32'></td>
                        <td id='33'></td><td id='34'></td>
                        <td id='35'></td><td id='36'></td>
                        <td id='37'></td><td id='38'></td>
                    </tr>
                    <tr id='row4'>
                        <td id='41'></td><td id='42'></td>
                        <td id='43'></td><td id='44'></td>
                        <td id='45'></td><td id='46'></td>
                        <td id='47'></td><td id='48'></td>
                    </tr>
                    <tr id='row5'>
                        <td id='51'></td><td id='52'></td>
                        <td id='53'></td><td id='54'></td>
                        <td id='55'></td><td id='56'></td>
                        <td id='57'></td><td id='58'></td>
                    </tr>
                    <tr id='row6'>
                        <td id='61'></td><td id='62'></td>
                        <td id='63'></td><td id='64'></td>
                        <td id='65'></td><td id='66'></td>
                        <td id='67'></td><td id='68'></td>
                    </tr>
                    <tr id='row7'>
                        <td id='71'></td><td id='72'></td>
                        <td id='73'></td><td id='74'></td>
                        <td id='75'></td><td id='76'></td>
                        <td id='77'></td><td id='78'></td>
                    </tr>
                    <tr id='row8'>
                        <td id='81'></td><td id='82'></td>
                        <td id='83'></td><td id='84'></td>
                        <td id='85'></td><td id='86'></td>
                        <td id='87'></td><td id='88'></td>
                    </tr>
                </table>
            </div>

        </div>
    </body>
</html>